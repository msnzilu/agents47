{% extends 'users/base.html' %}

{% block title %}Compare Search Methods - {{ knowledge_base.title }}{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav class="text-sm mb-6">
    <ol class="flex items-center space-x-2">
        <li><a href="{% url 'agents:agent-list' %}" class="text-blue-600 hover:underline">Agents</a></li>
        <li class="text-gray-500">/</li>
        <li><a href="{% url 'agents:agent-detail' agent.id %}" class="text-blue-600 hover:underline">{{ agent.name }}</a></li>
        <li class="text-gray-500">/</li>
        <li><a href="{% url 'agents:knowledge-base-detail' knowledge_base.id %}" class="text-blue-600 hover:underline">{{ knowledge_base.title }}</a></li>
        <li class="text-gray-500">/</li>
        <li class="text-gray-700">Compare Search Methods</li>
    </ol>
</nav>

<!-- Header -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">üî¨ Compare Search Methods</h1>
    <p class="text-gray-600">
        Test and compare different search approaches to optimize your knowledge base retrieval
    </p>
</div>

<!-- Search Form -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <form method="post" class="space-y-4">
        {% csrf_token %}
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Search Query</label>
            <textarea name="query" rows="2" required
                      placeholder="e.g., How do I reset my password?"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">{{ query }}</textarea>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Results per Method</label>
                <select name="top_k" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="3" {% if request.POST.top_k == "3" %}selected{% endif %}>3 results</option>
                    <option value="5" {% if request.POST.top_k == "5" or not request.POST.top_k %}selected{% endif %}>5 results</option>
                    <option value="10" {% if request.POST.top_k == "10" %}selected{% endif %}>10 results</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Methods to Compare</label>
                <div class="space-y-1">
                    <label class="flex items-center text-sm">
                        <input type="checkbox" name="methods" value="vector" checked 
                               class="mr-2 rounded border-gray-300 text-blue-600">
                        Vector Only
                    </label>
                    <label class="flex items-center text-sm">
                        <input type="checkbox" name="methods" value="hybrid" checked 
                               class="mr-2 rounded border-gray-300 text-blue-600">
                        Hybrid Search
                    </label>
                    <label class="flex items-center text-sm">
                        <input type="checkbox" name="methods" value="keyword" 
                               class="mr-2 rounded border-gray-300 text-blue-600">
                        Keyword Only
                    </label>
                </div>
            </div>

            <div class="flex items-end">
                <button type="submit" 
                        class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                    üîç Compare Methods
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Results Comparison -->
{% if comparison_results %}
<div class="space-y-6">
    <!-- Query Display -->
    <div class="bg-gray-50 rounded-lg p-4">
        <p class="text-sm text-gray-600 mb-1">Query:</p>
        <p class="text-lg font-medium text-gray-900">{{ query }}</p>
    </div>

    <!-- Performance Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-{{ comparison_results|length }} gap-4">
        {% for method, data in comparison_results.items %}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <h3 class="font-semibold text-gray-900 mb-2 capitalize">{{ method }} Search</h3>
            <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600">Time:</span>
                    <span class="font-medium">{{ data.time_ms|floatformat:0 }}ms</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Results:</span>
                    <span class="font-medium">{{ data.results|length }}</span>
                </div>
                {% if data.avg_score %}
                <div class="flex justify-between">
                    <span class="text-gray-600">Avg Score:</span>
                    <span class="font-medium">{{ data.avg_score|floatformat:3 }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Side-by-Side Results -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-6">üìä Side-by-Side Results</h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-{{ comparison_results|length }} gap-6">
            {% for method, data in comparison_results.items %}
            <div>
                <h3 class="font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200 capitalize">
                    {% if method == 'vector' %}üîÆ Vector Search
                    {% elif method == 'hybrid' %}‚ö° Hybrid Search
                    {% elif method == 'keyword' %}üîç Keyword Search
                    {% endif %}
                </h3>
                
                <div class="space-y-4">
                    {% for result in data.results %}
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <!-- Rank Badge -->
                        <div class="flex items-start justify-between mb-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-600 text-white text-xs font-bold">
                                {{ forloop.counter }}
                            </span>
                            <div class="text-right">
                                {% if result.hybrid_score %}
                                <div class="text-xs text-gray-600">Score</div>
                                <div class="text-sm font-bold text-blue-600">{{ result.hybrid_score|floatformat:3 }}</div>
                                {% elif result.similarity %}
                                <div class="text-xs text-gray-600">Similarity</div>
                                <div class="text-sm font-bold text-green-600">{{ result.similarity|floatformat:3 }}</div>
                                {% elif result.keyword_score %}
                                <div class="text-xs text-gray-600">BM25</div>
                                <div class="text-sm font-bold text-purple-600">{{ result.keyword_score|floatformat:3 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Content -->
                        <p class="text-sm text-gray-700 mb-2">{{ result.content|truncatewords:30 }}</p>
                        
                        <!-- Metadata -->
                        <div class="text-xs text-gray-500">
                            Chunk {{ result.chunk_index|default:result.id }}
                        </div>
                    </div>
                    {% endfor %}

                    {% if not data.results %}
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                        <p class="text-sm text-yellow-800">No results found</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Overlap Analysis -->
    {% if overlap_analysis %}
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-blue-900 mb-4">üîÑ Results Overlap Analysis</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            {% for comparison, data in overlap_analysis.items %}
            <div class="bg-white rounded-lg p-4">
                <div class="font-medium text-gray-900 mb-2">{{ comparison }}</div>
                <div class="space-y-1">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Common results:</span>
                        <span class="font-medium">{{ data.common }} / {{ data.total }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Overlap:</span>
                        <span class="font-medium">{{ data.overlap_percent|floatformat:0 }}%</span>
                    </div>
                </div>
                <div class="mt-2">
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" 
                             style="width: {{ data.overlap_percent }}%"></div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Recommendations -->
    <div class="bg-green-50 border border-green-200 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-green-900 mb-3">üí° Recommendations</h3>
        <div class="space-y-2 text-green-800 text-sm">
            {% if recommendation %}
                {{ recommendation }}
            {% else %}
            <p><strong>Hybrid Search</strong> typically provides the best balance of semantic understanding and exact matching.</p>
            <p><strong>Vector Search</strong> is best for conceptual/semantic queries where exact terms don't matter.</p>
            <p><strong>Keyword Search</strong> works best when users know exact terms or technical jargon.</p>
            {% endif %}
        </div>
    </div>
</div>
{% else %}
<!-- Instructions -->
<div class="bg-blue-50 border border-blue-200 rounded-lg p-8 text-center">
    <h3 class="text-xl font-semibold text-blue-900 mb-3">üëÜ Enter a Query Above</h3>
    <p class="text-blue-800 mb-4">
        Compare different search methods to find the best approach for your knowledge base
    </p>
    <ul class="text-left max-w-2xl mx-auto space-y-2 text-blue-800 text-sm">
        <li>‚Ä¢ <strong>Vector Search:</strong> Pure semantic similarity using embeddings</li>
        <li>‚Ä¢ <strong>Hybrid Search:</strong> Combines vector + keyword matching with optional reranking</li>
        <li>‚Ä¢ <strong>Keyword Search:</strong> BM25 algorithm for exact term matching</li>
    </ul>
</div>
{% endif %}

<!-- Test Queries -->
<div class="mt-6 bg-gray-50 rounded-lg p-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">üß™ Try These Example Queries</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
        <button onclick="fillQuery('How do I reset my password?')"
                class="text-left px-4 py-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 transition text-sm">
            "How do I reset my password?"
        </button>
        <button onclick="fillQuery('What are the pricing options?')"
                class="text-left px-4 py-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 transition text-sm">
            "What are the pricing options?"
        </button>
        <button onclick="fillQuery('integration setup guide')"
                class="text-left px-4 py-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 transition text-sm">
            "integration setup guide"
        </button>
        <button onclick="fillQuery('API authentication errors')"
                class="text-left px-4 py-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 transition text-sm">
            "API authentication errors"
        </button>
        <button onclick="fillQuery('best practices for security')"
                class="text-left px-4 py-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 transition text-sm">
            "best practices for security"
        </button>
        <button onclick="fillQuery('troubleshooting connection issues')"
                class="text-left px-4 py-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 transition text-sm">
            "troubleshooting connection issues"
        </button>
    </div>
</div>

<script>
function fillQuery(query) {
    document.querySelector('[name="query"]').value = query;
}
</script>
{% endblock %}