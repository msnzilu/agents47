{% extends 'users/base.html' %}
{% block title %}Manage API Keys - AI Agent Platform{% endblock %}
{% block content %}
<div class="max-w-5xl mx-auto p-4">
  <!-- Header -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-semibold text-gray-800">Your API Keys</h1>
      <a href="{% url 'integrations:api_key_create' %}" class="btn btn-primary flex items-center">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
        Create API Key
      </a>
    </div>
  </div>

  <!-- API Keys List -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200">
    {% if api_keys %}
      <div class="divide-y divide-gray-200">
        {% for api_key in api_keys %}
          <div class="p-4 flex items-center justify-between hover:bg-gray-50">
            <div>
              <h3 class="text-lg font-medium text-gray-900">{{ api_key.name }}</h3>
              <p class="text-sm text-gray-500">Key: {{ api_key.key|slice:":8" }}... | Scopes: {{ api_key.scopes|join:", " }}</p>
              {% if api_key.last_used_at %}
                <p class="text-sm text-gray-500">Last Used: {{ api_key.last_used_at|date:"SHORT_DATE_FORMAT" }} {{ api_key.last_used_at|time:"TIME_FORMAT" }}</p>
              {% endif %}
            </div>
            <div class="flex space-x-2">
              <a href="{% url 'integrations:api_key_detail' pk=api_key.id %}" class="text-indigo-600 hover:text-indigo-800">View</a>
              <form action="{% url 'integrations:api_key_delete' pk=api_key.id %}" method="post" class="inline" onsubmit="return confirm('Are you sure you want to delete this API key?');">
                {% csrf_token %}
                <button type="submit" class="text-red-600 hover:text-red-800">Delete</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="p-4 text-center">
        <p class="text-gray-500">No API keys created. Create one to get started!</p>
        <a href="{% url 'integrations:api_key_create' %}" class="btn btn-primary mt-2">Create API Key</a>
      </div>
    {% endif %}
  </div>
</div>

<!-- JavaScript for AJAX delete -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const deleteForms = document.querySelectorAll('form[action*="api_key_delete"]');
    deleteForms.forEach(form => {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!confirm('Are you sure you want to delete this API key?')) return;
        try {
          const response = await fetch(form.action, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: new FormData(form)
          });
          if (response.ok) {
            form.closest('.flex').remove();
            if (!document.querySelector('.divide-y').children.length) {
              window.location.reload(); // Refresh to show empty state
            }
          } else {
            alert('Failed to delete API key. Please try again.');
          }
        } catch (error) {
          alert('An error occurred. Please try again.');
        }
      });
    });
  });
</script>
{% endblock %}